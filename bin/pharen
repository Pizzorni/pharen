#! /usr/bin/env php
<?php
$dir = dirname(__FILE__);
$pharen_dir = substr($dir, 0, strrpos($dir, DIRECTORY_SEPARATOR));
include($pharen_dir.DIRECTORY_SEPARATOR."pharen.php");

if(__FILE__ === realpath($_SERVER['SCRIPT_NAME'])){
    $input_files = array();
    if(isset($argv) && isset($argv[1])){
        array_shift($argv);
        foreach($argv as $arg){
            if(strpos($arg, "--") === 0){
                set_flag(substr($arg, 2));
            }else{
                $input_files[] = $arg;
            }
        }
    }

    $old_lang_setting = isset(Flags::$flags['no-import-lang']) ? Flags::$flags['no-import-lang'] : False;
    $old_lexi_setting = isset(Flags::$flags['import-lexi-relative']) ? Flags::$flags['import-lexi-relative'] : False;
    set_flag("no-import-lang");
    set_flag("import-lexi-relative");
    if(!$old_lang_setting){
        $lang_code = compile_file(COMPILER_SYSTEM . DIRECTORY_SEPARATOR . "lang.phn");
    }
    set_flag("import-lexi-relative", $old_lexi_setting);
    set_flag("no-import-lang", $old_lang_setting);

    $php_code = "";
    if(isset($_SERVER['REQUEST_METHOD'])){
        $php_code = $lang_code;
    }else{
        $php_code = "";
    }
    //require(SYSTEM . "/lang.php");
    foreach($input_files as $file){
        $php_code .= compile_file($file);
    }
    if(isset($_SERVER['REQUEST_METHOD'])){
        echo "<pre>$php_code</pre>";
    }
}
